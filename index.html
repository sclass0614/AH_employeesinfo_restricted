<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>직원 관리 정보</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script type="module" src="https://sclass0614.github.io/authCheck/authCheck.js"></script>
</head>

<body>
  <div id="loadingOverlay">
    <div class="loader"></div>
    <div>데이터를 처리중입니다...</div>
  </div>

  <div class="container" id="mainContainer">
    <div class="header" id="headerSection">
      <div class="title" id="pageTitle">우리집 데이케어 센터 직원 관리</div>
    </div>

    <div class="button-group" id="mainButtonGroup">
      <div class="search-area">
        <div class="reference-date-container">
          <input type="date" class="reference-date-input" name="referenceDate" id="referenceDate" />
        </div>
        <button class="btn search-button" id="activeEmployeeBtn">
          재직직원 조회
        </button>
        <button class="btn search-button" id="allEmployeeBtn">
          전직원 조회
        </button>
      </div>
      <div class="enroll-button">
        <button class="btn" id="newEmployeeBtn">신규직원등록</button>
      </div>
    </div>

    <div class="content-wrapper" id="contentArea">
      <div class="employee-list" id="employeeListContainer">
        <h3 class="employee-list-title" id="employeeListTitle">직원 목록</h3>
        <div class="table-container">
          <table id="employeeTable">
            <thead>
              <tr>
                <th data-sort="employeeId">직원번호</th>
                <th data-sort="name">직원명</th>
                <th data-sort="jobType">담당직종</th>
                <th data-sort="mobile">휴대전화번호</th>
                <th data-sort="startDate">계약시작일</th>
                <th data-sort="endDate">계약종료일</th>
              </tr>
            </thead>
            <tbody id="employeeTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="employee-form-container" id="employeeFormWrapper">
        <form id="employeeForm">
          <div class="info-frame_main" id="basicInfoFrame">
            <h3 class="info-section-title" id="basicInfoTitle">기본 정보</h3>
            <div class="row-2col">
              <div class="col-2">
                <label class="form-label">직원번호</label>
                <input type="text" class="form-input" name="employeeId" id="employeeId" readonly />
              </div>
              <div class="col-2">
                <label class="form-label">직원명</label>
                <input type="text" class="form-input" name="name" id="name" />
              </div>
            </div>

            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">주민등록번호</label>
                <input type="text" class="form-input ssn-input" name="ssn" id="ssn" />
              </div>
              <div class="col-3">
                <label class="form-label">생년월일</label>
                <input type="text" class="form-input" name="birthdate" id="birthdate" placeholder="ex)20250101" />
              </div>
              <div class="col-3">
                <label class="form-label">(만)나이</label>
                <input type="text" class="form-input" name="age" id="age" readonly />
              </div>
            </div>

            <div class="row-2col">
              <div class="col-2">
                <label class="form-label">주소</label>
                <input type="text" class="form-input" name="address" id="address" />
              </div>
              <div class="col-2">
                <label class="form-label">이메일주소</label>
                <input type="email" class="form-input" name="email" id="email" />
              </div>
            </div>

            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">휴대전화번호</label>
                <input type="text" class="form-input" name="mobile" id="mobile" />
              </div>
              <div class="col-3">
                <label class="form-label">전화번호</label>
                <input type="text" class="form-input" name="phone" id="phone" />
              </div>
              <div class="col-3">
                <label class="form-label">비상연락망</label>
                <input type="text" class="form-input" name="emergency" id="emergency" />
              </div>
            </div>
          </div>

          <div class="tab-buttons" id="formTabButtons">
            <button type="button" class="tab-button active" data-tab="contract" id="contractTabBtn">
              계약사항
            </button>
            <button type="button" class="tab-button" data-tab="duty" id="dutyTabBtn">
              의무사항
            </button>
            <button type="button" class="tab-button" data-tab="account" id="accountTabBtn">
              계좌사항
            </button>
            <button type="button" class="tab-button" data-tab="qualification" id="qualificationTabBtn">
              자격사항
            </button>
          </div>

          <div id="contract" class="tab-content active">
            <div class="info-frame_additional" id="contractInfoFrame">
              <div class="row-2col">
                <div class="col-2">
                  <label class="form-label">근무구분</label>
                  <select class="form-input" name="workType" id="workType">
                    <option value="선택">선택</option>
                    <option value="정규직">정규직</option>
                    <option value="계약직">계약직</option>
                    <option value="일용직">일용직</option>
                    <option value="시간강사">시간강사</option>
                    <option value="기타프리랜서">기타프리랜서</option>
                    <option value="자원봉사자">자원봉사자</option>
                  </select>
                </div>
                <div class="col-2">
                  <label class="form-label">담당직종</label>
                  <select class="form-input" name="position" id="position">
                    <option value="선택">선택</option>
                    <option value="시설장">시설장</option>
                    <option value="사무국장">사무국장</option>
                    <option value="사회복지사">사회복지사</option>
                    <option value="작업치료사">작업치료사</option>
                    <option value="물리치료사">물리치료사</option>
                    <option value="요양보호사">요양보호사</option>
                    <option value="조리원">조리원</option>
                    <option value="운전원">운전원</option>
                    <option value="사무원">사무원</option>
                  </select>
                </div>
              </div>

              <div class="row-3col">
                <div class="col-3">
                  <label class="form-label">계약일</label>
                  <input type="text" class="form-input" name="contractDate" id="contractDate"
                    placeholder="ex)20250101" />
                </div>
                <div class="col-3">
                  <label class="form-label">계약시작일</label>
                  <input type="text" class="form-input" name="contractStart" id="contractStart"
                    placeholder="ex)20250101" />
                </div>
                <div class="col-3">
                  <label class="form-label">계약종료일</label>
                  <input type="text" class="form-input" name="contractEnd" id="contractEnd" value="99991231"
                    placeholder="ex)99991231" />
                </div>
              </div>

              <div class="row-3col">
                <div class="col-3">
                  <label class="form-label">근무시작시간</label>
                  <input type="text" class="form-input" name="workStart" id="workStart" placeholder="ex)0900" />
                </div>
                <div class="col-3">
                  <label class="form-label">근무종료시간</label>
                  <input type="text" class="form-input" name="workEnd" id="workEnd" placeholder="ex)1800" />
                </div>
                <div class="col-3">
                  <label class="form-label">휴게시간</label>
                  <select class="form-input" name="breakTime" id="breakTime">
                    <option value="0H">0H</option>
                    <option value="0.5H">0.5H</option>
                    <option value="1H">1H</option>
                    <option value="1.5H">1.5H</option>
                    <option value="2H">2H</option>
                    <option value="2.5H">2.5H</option>
                    <option value="3H">3H</option>
                    <option value="3.5H">3.5H</option>
                    <option value="4H">4H</option>
                    <option value="4.5H">4.5H</option>
                    <option value="5H">5H</option>
                    <option value="5.5H">5.5H</option>
                    <option value="6H">6H</option>
                  </select>
                </div>
                <div class="col-3">
                  <label class="form-label">일일근무시간</label>
                  <input type="text" class="form-input" name="dailyHours" id="dailyHours" readonly />
                </div>
              </div>

              <div class="row-2col">
                <div class="col-2">
                  <label class="form-label">근무요일</label>
                  <div class="workdays-checkbox-container">
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="월" class="workday-checkbox" checked />
                      월
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="화" class="workday-checkbox" checked />
                      화
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="수" class="workday-checkbox" checked />
                      수
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="목" class="workday-checkbox" checked />
                      목
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="금" class="workday-checkbox" checked />
                      금
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="토" class="workday-checkbox" />
                      토
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="일" class="workday-checkbox" />
                      일
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="workDays" value="해당없음" class="workday-checkbox" id="workdayNone" />
                      해당없음
                    </label>
                  </div>
                </div>
              </div>

              <div class="row-1col">
                <div class="col-1" style="width: 100%">
                  <label class="form-label">기타근무유형(상세기재)</label>
                  <input type="text" class="form-input" name="otherWorkType" id="otherWorkType" />
                </div>
              </div>
            </div>
          </div>

          <div id="duty" class="tab-content">
            <div class="info-frame_additional" id="dutyInfoFrame">
              <div class="row-2col">
                <div class="col-2">
                  <label class="form-label">건강검진일</label>
                  <input type="date" class="form-input" name="health_checkup_date" id="health_checkup_date" />
                </div>
                <div class="col-2">
                  <label class="form-label">범죄경력조회일</label>
                  <input type="date" class="form-input" name="criminal_record_check_date"
                    id="criminal_record_check_date" />
                </div>
              </div>

              <div class="row-2col">
                <div class="col-3">
                  <label class="form-label">치매교육이수일</label>
                  <input type="date" class="form-input" name="dementia_training_date" id="dementia_training_date" />
                </div>
                <div class="col-3">
                </div>
              </div>
            </div>
          </div>

          <div id="account" class="tab-content">
            <div class="info-frame_additional" id="accountInfoFrame">
              <div class="row-3col">
                <div class="col-3">
                  <label class="form-label">계좌번호</label>
                  <input type="text" class="form-input" name="bank_account" id="bankAccount" placeholder="'-' 없이 입력" />
                </div>
                <div class="col-3">
                  <label class="form-label">계좌은행</label>
                  <input type="text" class="form-input" name="bank_name" id="bankName" />
                </div>
                <div class="col-3">
                  <label class="form-label">예금주</label>
                  <input type="text" class="form-input" name="account_holder" id="accountHolder" />
                </div>
              </div>
            </div>
          </div>

          <div id="qualification" class="tab-content">
            <div class="info-frame_additional" id="qualificationInfoFrame">
              <div class="table-container">
                <table class="qualification-table" id="qualificationTable">
                  <thead>
                    <tr>
                      <th>자격증명</th>
                      <th>자격번호</th>
                      <th>자격증취득일</th>
                      <th>자격증만료일</th>
                      <th>자격증발행처</th>
                      <th>관리</th>
                    </tr>
                  </thead>
                  <tbody id="qualificationList">
                    <tr id="qualificationInputRow">
                      <td>
                        <input type="text" class="form-input" name="cert_name" id="certName" placeholder="자격증명" />
                      </td>
                      <td>
                        <input type="text" class="form-input" name="cert_number" id="certNumber" placeholder="자격번호" />
                      </td>
                      <td>
                        <input type="text" class="form-input" name="cert_date" id="certDate"
                          placeholder="ex)20250101" />
                      </td>
                      <td>
                        <input type="text" class="form-input" name="cert_expiry_date" id="certExpiryDate"
                          placeholder="ex)99991231" />
                      </td>
                      <td>
                        <input class="form-input" name="cert_issuer" id="certIssuer" placeholder="발행처" type="text" />
                      </td>
                      <td>
                        <button type="button" class="btn" id="saveQualificationBtn">
                          저장
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="form-button-group" id="formButtonGroup">
            <button type="button" class="btn" id="resetBtn">초기화</button>
            <button type="button" class="btn" id="submitBtn">입력</button>
            <button type="button" class="btn" id="editBtn">수정</button>
            <button type="button" class="btn" id="deleteBtn">삭제</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="customModal">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-title">알림</div>
        <div class="modal-close">&times;</div>
      </div>
      <div class="modal-body" id="modalMessage">
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="modalConfirmBtn">확인</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirmModal">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-title">확인</div>
        <div class="modal-close">&times;</div>
      </div>
      <div class="modal-body" id="confirmModalMessage">
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="confirmYesBtn">확인</button>
        <button class="modal-btn cancel-btn" id="confirmNoBtn">취소</button>
      </div>
    </div>
  </div>
</body>

<script>
  let employeeData = [];
  let certData = [];

  let originalSSN = "";

  function maskSSN(ssn) {
    if (!ssn || ssn.length < 8) {
      return ssn;
    }
    
    if (ssn.includes('-') && ssn.length === 14) {
      return ssn.substring(0, 8) + "******";
    }
    
    return ssn;
  }

  function getOriginalSSN() {
    return originalSSN;
  }

  function setOriginalSSN(ssn) {
    originalSSN = ssn;
  }

  function showLoading() {
    document.getElementById("loadingOverlay").style.display = "flex";
  }

  function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
  }

  function openModal(modalId) {
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
      modalElement.style.display = "flex";
    }
  }

  function closeModal(modalId) {
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
      modalElement.style.display = "none";
    }
  }

  function showAlert(message) {
    document.getElementById("modalMessage").textContent = message;
    openModal("customModal");
  }

  window.showAlert = showAlert;

  function showConfirm(message, yesCallback, noCallback) {
    currentYesCallback = yesCallback;
    currentNoCallback = noCallback;

    document.getElementById("confirmModalMessage").textContent = message;

    openModal("confirmModal");
  }

  async function initializeData() {
    showLoading();
    try {
      initSupabase();

      await loadAllData();

      await loadCertData();

      const today = new Date();
      const dateStr = today.toISOString().split("T")[0];
      document.getElementById("referenceDate").value = dateStr;

      table_CurrentEmployee();
    } catch (error) {
      showAlert("데이터 로드 중 오류가 발생했습니다.");
    } finally {
      hideLoading();
    }
  }

  async function loadAllData() {
    return new Promise(async (resolve, reject) => {
      showLoading();
      try {
        const allData = await getData_All();
        storedData_all = allData;
        hideLoading();
        resolve(allData);
      } catch (error) {
        hideLoading();
        reject(error);
      }
    });
  }

  function move_EmployeeLineData() {
    return new Promise((resolve, reject) => {
      const employeeId = selectedMemberId;

      if (!employeeId) {
        showAlert("직원등록_ID가 없습니다. 직원을 먼저 선택해주세요.");
        reject("직원등록_ID가 없습니다.");
        return;
      }

      showLoading();

      move_EmployeeLine(employeeId)
        .then((result) => {
          hideLoading();

          if (result.success) {
            resolve(result);
          } else {
            showAlert(result.message);
            reject(result.message);
          }
        })
        .catch((error) => {
          hideLoading();
          showAlert("직원 데이터 이동 중 오류가 발생했습니다: " + error);
          reject(error);
        });
    });
  }

  async function add_CertData() {
    try {
      const formData = {
        employeeId: document.getElementById("employeeId").value,
        employeeName: document.getElementById("name").value,
        certName: document.getElementById("certName").value,
        certNumber: document.getElementById("certNumber").value,
        certDate: document.getElementById("certDate").value,
        certExpiryDate: document.getElementById("certExpiryDate").value,
        certIssuer: document.getElementById("certIssuer").value,
      };

      if (!formData.certName) {
        return { success: false, message: "자격증명을 입력해주세요." };
      }

      const result = await processCertFormData(formData);

      if (result.success) {
        await loadCertData();
        updateCertTable();

        document.getElementById("certName").value = "";
        document.getElementById("certNumber").value = "";
        document.getElementById("certDate").value = "";
        document.getElementById("certExpiryDate").value = "";
        document.getElementById("certIssuer").value = "";

        return { success: true, message: result.message };
      } else {
        return { success: false, message: result.message };
      }
    } catch (error) {
      return {
        success: false,
        message: "자격증 데이터 저장 중 오류가 발생했습니다: " + error,
      };
    }
  }

  async function loadCertData() {
    return new Promise(async (resolve, reject) => {
      showLoading();
      try {
        const certData = await getData_Cert();
        storedData_cert = certData;
        hideLoading();
        resolve(certData);
      } catch (error) {
        hideLoading();
        reject(error);
      }
    });
  }

  function deleteCertData(certId) {
    return new Promise((resolve, reject) => {
      showLoading();

      deleteCertData_Supabase(certId)
        .then((result) => {
          hideLoading();

          if (result.success) {
            resolve(result);
          } else {
            showAlert(result.message);
            reject(result.message);
          }
        })
        .catch((error) => {
          hideLoading();
          showAlert("자격증 삭제 중 오류가 발생했습니다: " + error);
          reject(error);
        });
    });
  }

  let currentSortColumn = "employeeId";
  let sortDirection = "asc";

  function sortTable(column) {
    if (currentSortColumn === column) {
      sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
      currentSortColumn = column;
      sortDirection = "asc";
    }

    if (
      document
        .getElementById("employeeListTitle")
        .textContent.includes("재직")
    ) {
      table_CurrentEmployee();
    } else {
      table_AllEmployee();
    }
  }

  function table_CurrentEmployee() {
    if (!storedData_all || storedData_all.length === 0) {
      showAlert("데이터가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.");
      return;
    }

    const tableBody = document.getElementById("employeeTableBody");
    let referenceDate = document.getElementById("referenceDate").value;

    if (!referenceDate) {
      referenceDate = new Date().toISOString().split("T")[0];
      document.getElementById("referenceDate").value = referenceDate;
    }

    const formattedRefDate = referenceDate.replace(/-/g, "");
    const refDateNum = parseInt(formattedRefDate);

    tableBody.innerHTML = "";

    const filteredEmployees = storedData_all.filter((row) => {
      let startDateNum, endDateNum;

      if (typeof row.계약시작일 === "number") {
        startDateNum = row.계약시작일;
      }
      else if (row.계약시작일 && String(row.계약시작일).includes("-")) {
        startDateNum = parseInt(String(row.계약시작일).replace(/-/g, ""));
      }
      else if (row.계약시작일) {
        startDateNum = parseInt(row.계약시작일);
      } else {
        startDateNum = 0;
      }

      if (typeof row.계약종료일 === "number") {
        endDateNum = row.계약종료일;
      } else if (row.계약종료일 && String(row.계약종료일).includes("-")) {
        endDateNum = parseInt(String(row.계약종료일).replace(/-/g, ""));
      } else if (row.계약종료일) {
        endDateNum = parseInt(row.계약종료일);
      } else {
        endDateNum = 99991231;
      }

      return refDateNum >= startDateNum && refDateNum < endDateNum;
    });

    filteredEmployees.sort((a, b) => {
      let valueA, valueB;

      switch (currentSortColumn) {
        case "employeeId":
          valueA = a.직원번호 || "";
          valueB = b.직원번호 || "";
          break;
        case "name":
          valueA = a.직원명 || "";
          valueB = b.직원명 || "";
          break;
        case "jobType":
          valueA = a.근무구분 || "";
          valueB = b.근무구분 || "";
          break;
        case "mobile":
          valueA = a.휴대전화번호 || "";
          valueB = b.휴대전화번호 || "";
          break;
        case "startDate":
          if (typeof a.계약시작일 === "number") {
            valueA = a.계약시작일;
          } else if (a.계약시작일 && String(a.계약시작일).includes("-")) {
            valueA = parseInt(String(a.계약시작일).replace(/-/g, ""));
          } else {
            valueA = parseInt(a.계약시작일) || 0;
          }

          if (typeof b.계약시작일 === "number") {
            valueB = b.계약시작일;
          } else if (b.계약시작일 && String(b.계약시작일).includes("-")) {
            valueB = parseInt(String(b.계약시작일).replace(/-/g, ""));
          } else {
            valueB = parseInt(b.계약시작일) || 0;
          }
          break;
        case "endDate":
          if (typeof a.계약종료일 === "number") {
            valueA = a.계약종료일;
          } else if (a.계약종료일 && String(a.계약종료일).includes("-")) {
            valueA = parseInt(String(a.계약종료일).replace(/-/g, ""));
          } else {
            valueA = parseInt(a.계약종료일) || 0;
          }

          if (typeof b.계약종료일 === "number") {
            valueB = b.계약종료일;
          } else if (b.계약종료일 && String(b.계약종료일).includes("-")) {
            valueB = parseInt(String(b.계약종료일).replace(/-/g, ""));
          } else {
            valueB = parseInt(b.계약종료일) || 0;
          }
          break;
        default:
          valueA = a.직원번호 || "";
          valueB = b.직원번호 || "";
      }

      if (typeof valueA === "string" && typeof valueB === "string") {
        valueA = valueA.toLowerCase();
        valueB = valueB.toLowerCase();
      }

      if (sortDirection === "asc") {
        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
      } else {
        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
      }
    });

    filteredEmployees.forEach((row) => {
      const employeeNo = row.직원번호;
      const employeeName = row.직원명;
      const jobType = row.담당직종;
      const mobile = row.휴대전화번호;

      let contractStartDate, contractEndDate;

      if (typeof row.계약시작일 === "number") {
        const startStr = row.계약시작일.toString();
        contractStartDate = `${startStr.substring(0, 4)}-${startStr.substring(
          4,
          6
        )}-${startStr.substring(6, 8)}`;
      } else {
        contractStartDate = row.계약시작일 || "";
      }

      if (typeof row.계약종료일 === "number") {
        const endStr = row.계약종료일.toString();
        contractEndDate = `${endStr.substring(0, 4)}-${endStr.substring(
          4,
          6
        )}-${endStr.substring(6, 8)}`;
      } else {
        contractEndDate = row.계약종료일 || "";
      }

      const newRow = document.createElement("tr");
      newRow.innerHTML = `
            <td>${employeeNo || ""}</td>
            <td>${employeeName || ""}</td>
            <td>${jobType || ""}</td>
            <td>${mobile || ""}</td>
            <td>${contractStartDate || ""}</td>
            <td>${contractEndDate || ""}</td>
          `;

      tableBody.appendChild(newRow);

      newRow.addEventListener("dblclick", function () {
        const allRows = tableBody.querySelectorAll("tr");
        allRows.forEach((r) => r.classList.remove("selected-row"));
        newRow.classList.add("selected-row");

        document.getElementById("editBtn").disabled = false;
        document.getElementById("deleteBtn").disabled = false;
        document.getElementById("submitBtn").disabled = true;

        selectedMemberId = row.직원등록_id;

        fillEmployeeData(row);
      });
    });

    document.getElementById("employeeListTitle").textContent =
      "재직 직원 목록";
  }

  function table_AllEmployee() {
    if (!storedData_all || storedData_all.length === 0) {
      showAlert("데이터가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.");
      return;
    }

    const tableBody = document.getElementById("employeeTableBody");

    tableBody.innerHTML = "";

    const allEmployees = [...storedData_all];

    allEmployees.sort((a, b) => {
      let valueA, valueB;

      switch (currentSortColumn) {
        case "employeeId":
          valueA = a.직원번호 || "";
          valueB = b.직원번호 || "";
          break;
        case "name":
          valueA = a.직원명 || "";
          valueB = b.직원명 || "";
          break;
        case "jobType":
          valueA = a.근무구분 || "";
          valueB = b.근무구분 || "";
          break;
        case "mobile":
          valueA = a.휴대전화번호 || "";
          valueB = b.휴대전화번호 || "";
          break;
        case "startDate":
          if (typeof a.계약시작일 === "number") {
            valueA = a.계약시작일;
          } else if (a.계약시작일 && String(a.계약시작일).includes("-")) {
            valueA = parseInt(String(a.계약시작일).replace(/-/g, ""));
          } else {
            valueA = parseInt(a.계약시작일) || 0;
          }

          if (typeof b.계약시작일 === "number") {
            valueB = b.계약시작일;
          } else if (b.계약시작일 && String(b.계약시작일).includes("-")) {
            valueB = parseInt(String(b.계약시작일).replace(/-/g, ""));
          } else {
            valueB = parseInt(b.계약시작일) || 0;
          }
          break;
        case "endDate":
          if (typeof a.계약종료일 === "number") {
            valueA = a.계약종료일;
          } else if (a.계약종료일 && String(a.계약종료일).includes("-")) {
            valueA = parseInt(String(a.계약종료일).replace(/-/g, ""));
          } else {
            valueA = parseInt(a.계약종료일) || 0;
          }

          if (typeof b.계약종료일 === "number") {
            valueB = b.계약종료일;
          } else if (b.계약종료일 && String(b.계약종료일).includes("-")) {
            valueB = parseInt(String(b.계약종료일).replace(/-/g, ""));
          } else {
            valueB = parseInt(b.계약종료일) || 0;
          }
          break;
        default:
          valueA = a.직원번호 || "";
          valueB = b.직원번호 || "";
      }

      if (typeof valueA === "string" && typeof valueB === "string") {
        valueA = valueA.toLowerCase();
        valueB = valueB.toLowerCase();
      }

      if (sortDirection === "asc") {
        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
      } else {
        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
      }
    });

    allEmployees.forEach((row) => {
      const employeeNo = row.직원번호;
      const employeeName = row.직원명;
      const jobType = row.담당직종;
      const mobile = row.휴대전화번호;

      let contractStartDate, contractEndDate;

      if (typeof row.계약시작일 === "number") {
        const startStr = row.계약시작일.toString();
        contractStartDate = `${startStr.substring(0, 4)}-${startStr.substring(
          4,
          6
        )}-${startStr.substring(6, 8)}`;
      } else {
        contractStartDate = row.계약시작일 || "";
      }

      if (typeof row.계약종료일 === "number") {
        const endStr = row.계약종료일.toString();
        contractEndDate = `${endStr.substring(0, 4)}-${endStr.substring(
          4,
          6
        )}-${endStr.substring(6, 8)}`;
      } else {
        contractEndDate = row.계약종료일 || "";
      }

      const newRow = document.createElement("tr");
      newRow.innerHTML = `
            <td>${employeeNo || ""}</td>
            <td>${employeeName || ""}</td>
            <td>${jobType || ""}</td>
            <td>${mobile || ""}</td>
            <td>${contractStartDate || ""}</td>
            <td>${contractEndDate || ""}</td>
          `;

      const today = new Date();
      const formattedToday = today
        .toISOString()
        .split("T")[0]
        .replace(/-/g, "");
      const todayNum = parseInt(formattedToday);

      let endDateNum;

      if (typeof row.계약종료일 === "number") {
        endDateNum = row.계약종료일;
      } else if (row.계약종료일 && String(row.계약종료일).includes("-")) {
        endDateNum = parseInt(String(row.계약종료일).replace(/-/g, ""));
      } else if (row.계약종료일) {
        endDateNum = parseInt(row.계약종료일);
      } else {
        endDateNum = 99991231;
      }

      if (endDateNum <= todayNum) {
        newRow.style.backgroundColor = "#f0f0f0";
      }

      tableBody.appendChild(newRow);

      newRow.addEventListener("dblclick", function () {
        const allRows = tableBody.querySelectorAll("tr");
        allRows.forEach((r) => r.classList.remove("selected-row"));
        newRow.classList.add("selected-row");

        document.getElementById("editBtn").disabled = false;
        document.getElementById("deleteBtn").disabled = false;
        document.getElementById("submitBtn").disabled = true;

        selectedMemberId = row.직원등록_id;

        fillEmployeeData(row);
      });
    });

    document.getElementById("employeeListTitle").textContent =
      "전체 직원 목록";
  }

  function fillEmployeeData(data) {
    selectedMemberId = data.직원등록_id;
    selectedMemberData = data;

    document.getElementById("employeeId").value = data.직원번호 || "";
    document.getElementById("name").value = data.직원명 || "";
    
    const originalSsnValue = data.주민등록번호 || "";
    originalSSN = originalSsnValue;
    document.getElementById("ssn").value = maskSSN(originalSsnValue);

    if (typeof data.생년월일 === "number") {
      const birthStr = data.생년월일.toString();
      document.getElementById("birthdate").value = `${birthStr.substring(
        0,
        4
      )}-${birthStr.substring(4, 6)}-${birthStr.substring(6, 8)}`;
    } else {
      document.getElementById("birthdate").value = data.생년월일 || "";
    }

    document.getElementById("age").value = data.만나이 || "";
    document.getElementById("address").value = data.주소 || "";
    document.getElementById("email").value = data.이메일 || "";

    document.getElementById("mobile").value = data.휴대전화번호 || "";
    document.getElementById("phone").value = data.전화번호 || "";
    document.getElementById("emergency").value = data.비상연락망 || "";

    const workTypeSelect = document.getElementById("workType");
    if (workTypeSelect) {
      workTypeSelect.value = data.근무구분 || "";
    }

    const positionSelect = document.getElementById("position");
    if (positionSelect) {
      positionSelect.value = data.담당직종 || "";
    }

    if (typeof data.계약일 === "number") {
      const dateStr = data.계약일.toString();
      document.getElementById("contractDate").value = `${dateStr.substring(
        0,
        4
      )}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
    } else {
      document.getElementById("contractDate").value = data.계약일 || "";
    }

    if (typeof data.계약시작일 === "number") {
      const startStr = data.계약시작일.toString();
      document.getElementById("contractStart").value = `${startStr.substring(
        0,
        4
      )}-${startStr.substring(4, 6)}-${startStr.substring(6, 8)}`;
    } else {
      document.getElementById("contractStart").value = data.계약시작일 || "";
    }

    if (typeof data.계약종료일 === "number") {
      const endStr = data.계약종료일.toString();
      document.getElementById("contractEnd").value = `${endStr.substring(
        0,
        4
      )}-${endStr.substring(4, 6)}-${endStr.substring(6, 8)}`;
    } else {
      document.getElementById("contractEnd").value = data.계약종료일 || "";
    }

    document.getElementById("workStart").value = data.근무시작시간 || "";
    document.getElementById("workEnd").value = data.근무종료시간 || "";
    document.getElementById("breakTime").value = data.휴게시간 || "";

    const workdayCheckboxes = document.querySelectorAll(".workday-checkbox");
    const workdayNone = document.getElementById("workdayNone");

    workdayCheckboxes.forEach((checkbox) => {
      checkbox.checked = false;
      checkbox.disabled = false;
    });

    const workdays = data.근무요일 || [];

    if (Array.isArray(workdays)) {
      workdayCheckboxes.forEach((checkbox) => {
        if (workdays.includes(checkbox.value)) {
          checkbox.checked = true;
        }
      });

      if (workdays.includes("해당없음")) {
        workdayNone.checked = true;
        document
          .querySelectorAll(".workday-checkbox:not(#workdayNone)")
          .forEach((checkbox) => {
            checkbox.disabled = true;
          });
      } else {
        workdayNone.checked = false;
        workdayNone.disabled = workdays.length > 0;
      }
    }
    else if (typeof workdays === "string") {
      const workdaysArray = workdays.split("_");

      workdayCheckboxes.forEach((checkbox) => {
        if (workdaysArray.includes(checkbox.value)) {
          checkbox.checked = true;
        }
      });

      if (workdaysArray.includes("해당없음")) {
        workdayNone.checked = true;
        document
          .querySelectorAll(".workday-checkbox:not(#workdayNone)")
          .forEach((checkbox) => {
            checkbox.disabled = true;
          });
      } else {
        workdayNone.checked = false;
        workdayNone.disabled = workdaysArray.length > 0;
      }
    }

    document.getElementById("dailyHours").value = data.일일근무시간 || "";
    document.getElementById("otherWorkType").value = data.기타근무유형 || "";

    if (typeof data.건강검진일 === "number") {
      const dateStr = data.건강검진일.toString();
      document.getElementById(
        "health_checkup_date"
      ).value = `${dateStr.substring(0, 4)}-${dateStr.substring(
        4,
        6
      )}-${dateStr.substring(6, 8)}`;
    } else {
      document.getElementById("health_checkup_date").value =
        data.건강검진일 || "";
    }

    if (typeof data.범죄경력조회일 === "number") {
      const dateStr = data.범죄경력조회일.toString();
      document.getElementById(
        "criminal_record_check_date"
      ).value = `${dateStr.substring(0, 4)}-${dateStr.substring(
        4,
        6
      )}-${dateStr.substring(6, 8)}`;
    } else {
      document.getElementById("criminal_record_check_date").value =
        data.범죄경력조회일 || "";
    }

    if (typeof data.치매교육이수일 === "number") {
      const dateStr = data.치매교육이수일.toString();
      document.getElementById(
        "dementia_training_date"
      ).value = `${dateStr.substring(0, 4)}-${dateStr.substring(
        4,
        6
      )}-${dateStr.substring(6, 8)}`;
    } else {
      document.getElementById("dementia_training_date").value =
        data.치매교육이수일 || "";
    }

    if (data.직원번호) {
      table_selectedEmployeeCert(data.직원번호);
    }

    calculateDailyHours();

    document.getElementById("bankAccount").value = data.계좌번호 || "";
    document.getElementById("bankName").value = data.계좌은행 || "";
    document.getElementById("accountHolder").value = data.예금주 || "";

    document.querySelector('.tab-button[data-tab="basic"]').click();
  }

  function table_selectedEmployeeCert(employeeId) {
    if (!storedData_cert || storedData_cert.length === 0) {
      return;
    }

    const tableBody = document.getElementById("qualificationList");
    if (!tableBody) {
      return;
    }

    const inputRow = document.getElementById("qualificationInputRow");
    tableBody.innerHTML = "";

    if (inputRow) {
      tableBody.appendChild(inputRow);
    }

    const employeeCerts = storedData_cert.filter(
      (cert) => cert.직원번호 === employeeId
    );

    employeeCerts.forEach((cert) => {
      const certId = cert.자격등록_id || "";
      const certName = cert.자격증명 || "";
      const certNumber = cert.자격번호 || "";
      const certDate = cert.자격증취득일 || "";
      const certExpiryDate = cert.자격증만료일 || "";
      const certIssuer = cert.자격증발행처 || "";

      const newRow = document.createElement("tr");
      newRow.dataset.certId = certId;

      newRow.innerHTML = `
          <td>${certName}</td>
          <td>${certNumber}</td>
          <td>${certDate}</td>
          <td>${certExpiryDate}</td>
          <td>${certIssuer}</td>
          <td>
            <button type="button" class="btn btn-delete">삭제</button>
          </td>
        `;

      tableBody.appendChild(newRow);

      const deleteBtn = newRow.querySelector(".btn-delete");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", async function () {
          if (!certId) {
            showAlert(
              "자격증 ID가 없습니다. 자격증 데이터를 다시 로드해주세요."
            );
            return;
          }

          showConfirm(
            "이 자격증 정보를 삭제하시겠습니까?",
            async function () {
              try {
                showLoading();

                const result = await deleteCertData(certId);

                hideLoading();

                if (result.success) {
                  showAlert("자격증 정보가 삭제되었습니다.");

                  await loadCertData();

                  table_selectedEmployeeCert(employeeId);
                } else {
                  showAlert(result.message || "삭제 중 오류가 발생했습니다.");
                }
              } catch (error) {
                hideLoading();
                showAlert("자격증 삭제 중 오류가 발생했습니다: " + error);
              }
            }
          );
        });
      }
    });
  }

  function deleteCertData(certId) {
    return new Promise((resolve, reject) => {
      showLoading();

      deleteCertData_Supabase(certId)
        .then((result) => {
          hideLoading();

          if (result.success) {
            resolve(result);
          } else {
            showAlert(result.message);
            reject(result.message);
          }
        })
        .catch((error) => {
          hideLoading();
          showAlert("자격증 삭제 중 오류가 발생했습니다: " + error);
          reject(error);
        });
    });
  }

  function idNumberCheck(value) {
    if (value === "") {
      return true;
    }

    const cleanValue = value.replace(/-/g, "");

    const regex = /^\d{13}$/;
    return regex.test(cleanValue);
  }

  function idNumberChange(value) {
    if (value === "") {
      return "";
    }

    const cleanValue = value.replace(/-/g, "");

    if (!/^\d{13}$/.test(cleanValue)) {
      return value;
    }

    return cleanValue.substring(0, 6) + "-" + cleanValue.substring(6);
  }

  function idNumberDoubleCheck(value) {
    if (value === "") {
      return true;
    }

    const regex = /^\d{6}-\d{7}$/;
    return regex.test(value);
  }

  function date8numberCheck(value) {
    if (value === "") {
      return true;
    }

    const regex = /^\d{8}$/;
    return regex.test(value);
  }

  function manAge(birthDateStr) {
    if (!birthDateStr || !date8numberCheck(birthDateStr)) {
      return "";
    }

    const year = parseInt(birthDateStr.substring(0, 4));
    const month = parseInt(birthDateStr.substring(4, 6));
    const day = parseInt(birthDateStr.substring(6, 8));

    const birthDate = new Date(year, month - 1, day);
    if (
      birthDate.getFullYear() !== year ||
      birthDate.getMonth() !== month - 1 ||
      birthDate.getDate() !== day
    ) {
      return "";
    }

    const today = new Date();

    let age = today.getFullYear() - birthDate.getFullYear();

    const isBirthdayPassed =
      today.getMonth() > birthDate.getMonth() ||
      (today.getMonth() === birthDate.getMonth() &&
        today.getDate() >= birthDate.getDate());

    if (!isBirthdayPassed) {
      age--;
    }

    return age.toString();
  }

  function emailFormatCheck(email) {
    if (email === "") {
      return true;
    }

    const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return regex.test(email);
  }

  function phoneNumberCheck(value) {
    if (value === "") {
      return true;
    }

    const cleanValue = value.replace(/-/g, "");

    const isNumeric = /^\d+$/.test(cleanValue);

    return isNumeric && cleanValue.length <= 11;
  }

  function phoneNumberChange(value) {
    if (value === "") {
      return "";
    }

    const cleanValue = value.replace(/-/g, "").replace(/[^\d]/g, "");

    if (cleanValue.length === 8) {
      return cleanValue.substring(0, 4) + "-" + cleanValue.substring(4);
    } else if (cleanValue.length === 9) {
      if (cleanValue.startsWith("02")) {
        return (
          cleanValue.substring(0, 2) +
          "-" +
          cleanValue.substring(2, 5) +
          "-" +
          cleanValue.substring(5)
        );
      } else {
        return (
          cleanValue.substring(0, 3) +
          "-" +
          cleanValue.substring(3, 6) +
          "-" +
          cleanValue.substring(6)
        );
      }
    } else if (cleanValue.length === 10) {
      if (cleanValue.startsWith("02")) {
        return (
          cleanValue.substring(0, 2) +
          "-" +
          cleanValue.substring(2, 6) +
          "-" +
          cleanValue.substring(6)
        );
      } else {
        return (
          cleanValue.substring(0, 3) +
          "-" +
          cleanValue.substring(3, 6) +
          "-" +
          cleanValue.substring(6)
        );
      }
    } else if (cleanValue.length === 11) {
      return (
        cleanValue.substring(0, 3) +
        "-" +
        cleanValue.substring(3, 7) +
        "-" +
        cleanValue.substring(7)
      );
    } else {
      return cleanValue;
    }
  }

  function phoneNumberDoubleCheck(value) {
    if (value === "") {
      return true;
    }

    const regex =
      /^(01[0-9]{1}-\d{3,4}-\d{4}|02-\d{3,4}-\d{4}|0[3-9]{1}[0-9]{1}-\d{3}-\d{4}|070-\d{4}-\d{4}|\d{4}-\d{4})$/;
    return regex.test(value);
  }

  function calculateDailyHours() {
    const workStartField = document.getElementById("workStart");
    const workEndField = document.getElementById("workEnd");
    const breakTimeField = document.getElementById("breakTime");
    const dailyHoursField = document.getElementById("dailyHours");

    const workStartValue = workStartField.value.trim();
    const workEndValue = workEndField.value.trim();
    const breakTimeValue = breakTimeField.value.trim();

    if (!workStartValue || !workEndValue || !breakTimeValue) {
      dailyHoursField.value = "";
      return;
    }

    let startHour = 0;
    let startMinute = 0;

    if (workStartValue.includes(":")) {
      const parts = workStartValue.split(":");
      startHour = parseInt(parts[0], 10);
      startMinute = parseInt(parts[1], 10);
    } else {
      if (workStartValue.length === 4) {
        startHour = parseInt(workStartValue.substring(0, 2), 10);
        startMinute = parseInt(workStartValue.substring(2), 10);
      } else if (workStartValue.length === 3) {
        startHour = parseInt(workStartValue.substring(0, 1), 10);
        startMinute = parseInt(workStartValue.substring(1), 10);
      }
    }

    let endHour = 0;
    let endMinute = 0;

    if (workEndValue.includes(":")) {
      const parts = workEndValue.split(":");
      endHour = parseInt(parts[0], 10);
      endMinute = parseInt(parts[1], 10);
    } else {
      if (workEndValue.length === 4) {
        endHour = parseInt(workEndValue.substring(0, 2), 10);
        endMinute = parseInt(workEndValue.substring(2), 10);
      } else if (workEndValue.length === 3) {
        endHour = parseInt(workEndValue.substring(0, 1), 10);
        endMinute = parseInt(workEndValue.substring(1), 10);
      }
    }

    const startMinutes = startHour * 60 + startMinute;
    const endMinutes = endHour * 60 + endMinute;

    let breakHours = 0;
    if (breakTimeValue.includes("H")) {
      breakHours = parseFloat(breakTimeValue.replace("H", ""));
    }
    const breakMinutes = breakHours * 60;

    let totalWorkMinutes = endMinutes - startMinutes - breakMinutes;

    if (totalWorkMinutes < 0) {
      totalWorkMinutes = 0;
      showAlert("근무시작시간, 종료시간확인");
    }

    const totalWorkHours = Math.round((totalWorkMinutes / 60) * 10) / 10;

    dailyHoursField.value = `${totalWorkHours}H`;
  }

  function clearAllContents() {
    document.getElementById("employeeId").value = "";
    document.getElementById("name").value = "";
    document.getElementById("ssn").value = "";
    document.getElementById("birthdate").value = "";
    document.getElementById("age").value = "";
    document.getElementById("address").value = "";
    document.getElementById("email").value = "";
    document.getElementById("mobile").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("emergency").value = "";

    document.getElementById("bankAccount").value = "";
    document.getElementById("bankName").value = "";
    document.getElementById("accountHolder").value = "";

    document.getElementById("workType").value = "";
    document.getElementById("position").value = "";
    document.getElementById("contractDate").value = "";
    document.getElementById("contractStart").value = "";
    document.getElementById("contractEnd").value = "99991231";
    document.getElementById("workStart").value = "";
    document.getElementById("workEnd").value = "";
    document.getElementById("breakTime").value = "0H";
    document.getElementById("dailyHours").value = "";
    document.getElementById("otherWorkType").value = "";

    const workdayCheckboxes = document.querySelectorAll(".workday-checkbox");
    workdayCheckboxes.forEach((checkbox) => {
      if (["월", "화", "수", "목", "금"].includes(checkbox.value)) {
        checkbox.checked = true;
      } else {
        checkbox.checked = false;
      }
    });

    document.getElementById("workdayNone").disabled = true;

    document.getElementById("health_checkup_date").value = "";
    document.getElementById("criminal_record_check_date").value = "";
    document.getElementById("dementia_training_date").value = "";

    const qualificationList = document.getElementById("qualificationList");
    const qualificationRows = qualificationList.querySelectorAll(
      "tr:not(#qualificationInputRow)"
    );
    qualificationRows.forEach((row) => row.remove());

    document.getElementById("certName").value = "";
    document.getElementById("certNumber").value = "";
    document.getElementById("certDate").value = "";
    document.getElementById("certExpiryDate").value = "";
    document.getElementById("certIssuer").value = "";

    originalSSN = "";
  }

  function EntryCheck() {
    const requiredFields = [
      { id: "employeeId", name: "직원번호" },
      { id: "name", name: "직원명" },
      { id: "ssn", name: "주민등록번호" },
      { id: "birthdate", name: "생년월일" },
      { id: "address", name: "주소" },
      { id: "email", name: "이메일주소" },
      { id: "mobile", name: "휴대전화번호" },
      { id: "contractDate", name: "계약일" },
      { id: "contractStart", name: "계약시작일" },
      { id: "contractEnd", name: "계약종료일" },
    ];

    const requiredSelects = [
      { id: "workType", name: "근무구분" },
      { id: "position", name: "담당직종" },
    ];

    const missingFields = [];

    requiredFields.forEach((field) => {
      const value = document.getElementById(field.id).value.trim();
      if (!value) {
        missingFields.push(field.name);
      }
    });

    requiredSelects.forEach((field) => {
      const value = document.getElementById(field.id).value;
      if (!value || value === "선택" || value === "") {
        missingFields.push(field.name);
      }
    });

    const workdayCheckboxes = document.querySelectorAll(
      ".workday-checkbox:not(#workdayNone)"
    );
    const workdayNone = document.getElementById("workdayNone");

    const anyWorkdayChecked =
      Array.from(workdayCheckboxes).some((cb) => cb.checked) ||
      workdayNone.checked;

    if (!anyWorkdayChecked) {
      missingFields.push("근무요일");
    }

    if (missingFields.length > 0) {
      return {
        isValid: false,
        missingFields: missingFields,
      };
    }

    return {
      isValid: true,
      missingFields: [],
    };
  }

  function append_CertLineData(certData) {
    return new Promise(async (resolve, reject) => {
      try {
        showLoading();

        const result = await processCertFormData(certData);

        hideLoading();

        if (result.success) {
          resolve(result);
        } else {
          showAlert(result.message);
          reject(result.message);
        }
      } catch (error) {
        hideLoading();
        showAlert("자격증 저장 중 오류가 발생했습니다: " + error);
        reject(error);
      }
    });
  }

  function append_EmployeeLineData() {
    return new Promise((resolve, reject) => {
      const workdaysArray = Array.from(
        document.querySelectorAll(".workday-checkbox:checked")
      ).map((cb) => cb.value);

      const formData = {
        employeeId: document.getElementById("employeeId").value,
        name: document.getElementById("name").value,
        ssn: originalSSN || document.getElementById("ssn").value,
        birthdate: document.getElementById("birthdate").value,
        age: document.getElementById("age").value,
        address: document.getElementById("address").value,
        email: document.getElementById("email").value,
        mobile: document.getElementById("mobile").value,
        phone: document.getElementById("phone").value,
        emergency: document.getElementById("emergency").value,
        workType: document.getElementById("workType").value,
        position: document.getElementById("position").value,
        contractDate: document.getElementById("contractDate").value,
        contractStart: document.getElementById("contractStart").value,
        contractEnd: document.getElementById("contractEnd").value,
        workStart: document.getElementById("workStart").value,
        workEnd: document.getElementById("workEnd").value,
        breakTime: document.getElementById("breakTime").value,
        workdays: workdaysArray,
        dailyHours: document.getElementById("dailyHours").value,
        otherWorkType: document.getElementById("otherWorkType").value,
        healthCheckupDate: document.getElementById("health_checkup_date")
          .value,
        criminalRecordDate: document.getElementById(
          "criminal_record_check_date"
        ).value,
        dementiaTrainingDate: document.getElementById(
          "dementia_training_date"
        ).value,
        bankAccount: document.getElementById("bankAccount").value,
        bankName: document.getElementById("bankName").value,
        accountHolder: document.getElementById("accountHolder").value,
      };

      if (!formData.name) {
        showAlert("직원 이름을 입력해주세요.");
        reject("직원 이름이 입력되지 않았습니다.");
        return;
      }

      showLoading();

      processEmployeeFormData(formData)
        .then((result) => {
          hideLoading();

          if (result.success) {
            if (result.employeeId) {
              document.getElementById("employeeId").value = result.employeeId;
            }
            resolve(result);
          } else {
            showAlert(result.message);
            reject(result.message);
          }
        })
        .catch((error) => {
          hideLoading();
          showAlert("직원 데이터 저장 중 오류가 발생했습니다: " + error);
          reject(error);
        });
    });
  }

  function move_EmployeeLineData() {
    return new Promise((resolve, reject) => {
      const employeeId = selectedMemberId;

      if (!employeeId) {
        showAlert("직원등록_ID가 없습니다. 직원을 먼저 선택해주세요.");
        reject("직원등록_ID가 없습니다.");
        return;
      }

      showLoading();

      move_EmployeeLine(employeeId)
        .then((result) => {
          hideLoading();

          if (result.success) {
            resolve(result);
          } else {
            showAlert(result.message);
            reject(result.message);
          }
        })
        .catch((error) => {
          hideLoading();
          showAlert("직원 데이터 이동 중 오류가 발생했습니다: " + error);
          reject(error);
        });
    });
  }

  function generateNewEmployeeId() {
    const currentYear = new Date().getFullYear().toString().slice(-2);

    const prefix = "S" + currentYear;

    const existingIds = [];

    if (storedData_all && storedData_all.length > 0) {
      storedData_all.forEach((row) => {
        const employeeId = row[1];
        if (employeeId && employeeId.startsWith(prefix)) {
          existingIds.push(employeeId);
        }
      });
    }

    let maxNumber = 0;
    existingIds.forEach((id) => {
      const numberPart = parseInt(id.substring(3), 10);
      if (!isNaN(numberPart) && numberPart > maxNumber) {
        maxNumber = numberPart;
      }
    });

    const nextNumber = (maxNumber + 1).toString().padStart(3, "0");

    return prefix + nextNumber;
  }

  document.addEventListener("DOMContentLoaded", function () {
    initSupabase();

    initializeData();

    document.getElementById("editBtn").disabled = true;
    document.getElementById("deleteBtn").disabled = false;
    document.getElementById("submitBtn").disabled = false;

    const tableHeaders = document.querySelectorAll("#employeeTable th");
    tableHeaders.forEach((header) => {
      header.addEventListener("click", function () {
        const column = this.getAttribute("data-sort");
        sortTable(column);
      });

      header.style.cursor = "pointer";
    });

    const style = document.createElement("style");
    style.innerHTML = `
        th.sort-asc::after {
          content: '';
        }
        th.sort-desc::after {
          content: '';
        }
      `;
    document.head.appendChild(style);

    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");

    const customModal = document.getElementById("customModal");
    const modalClose = document.querySelector("#customModal .modal-close");
    const modalConfirmBtn = document.getElementById("modalConfirmBtn");

    if (modalClose) {
      modalClose.addEventListener("click", function () {
        closeModal();
      });
    }

    if (modalConfirmBtn) {
      modalConfirmBtn.addEventListener("click", function () {
        closeModal();
      });
    }

    const confirmModalClose = document.querySelector(
      "#confirmModal .modal-close"
    );
    const confirmNoBtn = document.getElementById("confirmNoBtn");

    if (confirmModalClose) {
      confirmModalClose.addEventListener("click", function () {
        closeConfirmModal();
      });
    }

    if (confirmNoBtn) {
      confirmNoBtn.addEventListener("click", function () {
        closeConfirmModal();
      });
    }

    const today = new Date().toISOString().split("T")[0];
    document.getElementById("referenceDate").value = today;

    tabButtons.forEach((button) => {
      button.addEventListener("click", function () {
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        tabContents.forEach((content) => content.classList.remove("active"));

        this.classList.add("active");
        const tabId = this.getAttribute("data-tab");
        document.getElementById(tabId).classList.add("active");
      });
    });

    const ssnField = document.getElementById("ssn");
    let isUserTyping = false;

    ssnField.addEventListener("input", function () {
      isUserTyping = true;
      if (this.value.includes('*')) {
        if (originalSSN && originalSSN.length > 0) {
          this.value = originalSSN;
        } else {
          this.value = "";
        }
      }
    });

    ssnField.addEventListener("keydown", function () {
      isUserTyping = true;
    });

    ssnField.addEventListener("focus", function () {
      isUserTyping = false;
    });

    ssnField.addEventListener("blur", function () {
      const value = this.value.trim();
      isUserTyping = false;

      if (value === "") {
        originalSSN = "";
        return;
      }

      if (value.includes('*') && originalSSN) {
        return;
      }

      if (!idNumberCheck(value)) {
        showAlert("주민등록번호는 13자리 숫자여야 합니다.");
        this.value = "";
        originalSSN = "";
        this.focus();
        return;
      }

      const formattedValue = idNumberChange(value);

      if (!idNumberDoubleCheck(formattedValue)) {
        showAlert("주민등록번호 형식이 올바르지 않습니다. (000000-0000000)");
        this.value = "";
        originalSSN = "";
        this.focus();
        return;
      }

      if (storedData_all && storedData_all.length > 0) {
        const isDuplicate = storedData_all.some(
          (row) => row.주민등록번호 === formattedValue
        );
        if (isDuplicate) {
          showAlert("등록된 동일한 주민번호가 있습니다.");
          this.value = "";
          originalSSN = "";
          this.focus();
          return;
        }
      }

      originalSSN = formattedValue;
      this.value = maskSSN(formattedValue);
    });

    const dateFields = [
      "birthdate",
      "contractDate",
      "contractStart",
      "contractEnd",
      "certDate",
      "certExpiryDate",
    ];

    dateFields.forEach((fieldId) => {
      const field = document.getElementById(fieldId);

      field.addEventListener("blur", function () {
        const value = this.value.trim();

        if (value !== "" && !date8numberCheck(value)) {
          showAlert("8자리 숫자만 입력 가능합니다. 예) 20230101");
          this.value = "";
          this.focus();
        }

        if (fieldId === "birthdate" && value !== "") {
          const age = manAge(value);
          document.getElementById("age").value = age;
        }
      });
    });

    const emailField = document.getElementById("email");

    emailField.addEventListener("blur", function () {
      const value = this.value.trim();

      if (value === "") {
        return;
      }

      if (!emailFormatCheck(value)) {
        showAlert("올바른 이메일 형식이 아닙니다. 예) example@domain.com");
        this.value = "";
        this.focus();
      }
    });

    const phoneFields = ["mobile", "phone", "emergency"];

    phoneFields.forEach((fieldId) => {
      const field = document.getElementById(fieldId);

      field.addEventListener("blur", function () {
        const value = this.value.trim();

        if (value === "") {
          return;
        }

        if (!phoneNumberCheck(value)) {
          showAlert("전화번호는 11자리 이하의 숫자만 입력 가능합니다.");
          this.value = "";
          this.focus();
          return;
        }

        this.value = phoneNumberChange(value);

        if (!phoneNumberDoubleCheck(this.value)) {
          showAlert("전화번호 형식이 올바르지 않습니다.");
          this.value = "";
          this.focus();
        }
      });
    });

    const workStartField = document.getElementById("workStart");
    const workEndField = document.getElementById("workEnd");
    const breakTimeField = document.getElementById("breakTime");

    workStartField.addEventListener("change", calculateDailyHours);
    workEndField.addEventListener("change", calculateDailyHours);
    breakTimeField.addEventListener("change", calculateDailyHours);

    const workdayCheckboxes = document.querySelectorAll(
      ".workday-checkbox:not(#workdayNone)"
    );
    const workdayNone = document.getElementById("workdayNone");

    const anyChecked = Array.from(workdayCheckboxes).some((cb) => cb.checked);
    workdayNone.disabled = anyChecked;

    workdayNone.addEventListener("change", function () {
      workdayCheckboxes.forEach((checkbox) => {
        checkbox.disabled = this.checked;
        if (this.checked) {
          checkbox.checked = false;
        }
      });
    });

    workdayCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", function () {
        const anyChecked = Array.from(workdayCheckboxes).some(
          (cb) => cb.checked
        );

        workdayNone.disabled = anyChecked;
        if (anyChecked) {
          workdayNone.checked = false;
        }
      });
    });

    document
      .getElementById("newEmployeeBtn")
      .addEventListener("click", function () {
        document.getElementById("employeeForm").reset();
      });

    document
      .getElementById("activeEmployeeBtn")
      .addEventListener("click", function () {
        table_CurrentEmployee();
        showAlert(
          `${document.getElementById("referenceDate").value
          } 기준 재직 중인 직원이 조회되었습니다.`
        );
      });

    document
      .getElementById("allEmployeeBtn")
      .addEventListener("click", function () {
        table_AllEmployee();
        showAlert(
          `${document.getElementById("referenceDate").value
          } 기준 직원이 조회되었습니다.`
        );
      });

    document
      .getElementById("referenceDate")
      .addEventListener("change", function () {
        table_AllEmployee();
      });

    document
      .getElementById("resetBtn")
      .addEventListener("click", function () {
        clearAllContents();
        document.querySelector("#contractTabBtn").click();
      });

    document
      .getElementById("deleteBtn")
      .addEventListener("click", function () {
        if (!selectedMemberId) {
          showAlert("삭제할 직원을 먼저 선택해주세요.");
          return;
        }

        showConfirm(
          "선택한 직원 정보를 삭제하시겠습니까? 삭제된 정보는 복구할 수 없습니다.",
          async function () {
            try {
              showLoading();

              const result = await move_EmployeeLine(selectedMemberId);

              hideLoading();

              if (result.success) {
                await loadAllData();
                table_CurrentEmployee();
                clearAllContents();

                document.getElementById("editBtn").disabled = true;
                document.getElementById("deleteBtn").disabled = true;
                document.getElementById("submitBtn").disabled = false;

                showAlert("직원 정보가 성공적으로 삭제되었습니다.");
              } else {
                showAlert(result.message || "삭제 중 오류가 발생했습니다.");
              }
            } catch (error) {
              hideLoading();
              showAlert("직원 정보 삭제 중 오류가 발생했습니다: " + error);
            }
          }
        );
      });

    document
      .getElementById("submitBtn")
      .addEventListener("click", async function (e) {
        e.preventDefault();

        const validationResult = EntryCheck();

        if (!validationResult.isValid) {
          const missingFieldsText = validationResult.missingFields.join(", ");
          showAlert(`다음 항목을 입력해주세요: ${missingFieldsText}`);
          return;
        }

        try {
          showLoading();

          await append_EmployeeLineData();

          await loadAllData();
          table_CurrentEmployee();
          clearAllContents();
          hideLoading();

          showAlert("직원 정보가 성공적으로 등록되었습니다.");
        } catch (error) {
          hideLoading();
          showAlert("데이터 처리 중 오류가 발생했습니다: " + error);
        }
      });

    calculateDailyHours();

    document
      .getElementById("editBtn")
      .addEventListener("click", async function () {
        const validationResult = EntryCheck();

        if (!validationResult.isValid) {
          const missingFieldsText = validationResult.missingFields.join(", ");
          showAlert(`다음 항목을 입력해주세요: ${missingFieldsText}`);
          return;
        }

        try {
          showLoading();

          await move_EmployeeLineData();

          await append_EmployeeLineData();

          await loadAllData();
          table_CurrentEmployee();

          clearAllContents();

          hideLoading();
          showAlert("직원 정보가 성공적으로 수정되었습니다.");
        } catch (error) {
          hideLoading();
          showAlert("직원 정보 수정 중 오류가 발생했습니다: " + error);
        }

        document.getElementById("editBtn").disabled = true;
        document.getElementById("deleteBtn").disabled = true;
        document.getElementById("submitBtn").disabled = false;
      });
    const newEmployeeBtn = document.getElementById("newEmployeeBtn");
    if (newEmployeeBtn) {
      newEmployeeBtn.addEventListener("click", function () {
        clearAllContents();

        document.getElementById("employeeId").value = "신규직원등록중";

        document.getElementById("submitBtn").disabled = false;
        document.getElementById("editBtn").disabled = true;
        document.getElementById("deleteBtn").disabled = true;

        const tableBody = document.getElementById("employeeTableBody");
        if (tableBody) {
          const allRows = tableBody.querySelectorAll("tr");
          allRows.forEach((row) => {
            row.classList.remove("selected-row");
          });
        }

        document.querySelector("#contractTabBtn").click();

        showAlert("새 직원등록을 시작합니다. 직원 정보를 입력해주세요.");
      });
    }

    document
      .getElementById("workStart")
      .addEventListener("blur", function () {
        const value = this.value.trim();

        if (value === "") {
          return;
        }

        const fourDigitRegex = /^\d{3,4}$/;
        if (!fourDigitRegex.test(value)) {
          showAlert("근무시작시간은 4자리 숫자로 입력해주세요. (예: 0900)");
          this.value = "";
          this.focus();
        }
      });

    document.getElementById("workEnd").addEventListener("blur", function () {
      const value = this.value.trim();

      if (value === "") {
        return;
      }

      const fourDigitRegex = /^\d{3,4}$/;
      if (!fourDigitRegex.test(value)) {
        showAlert("근무종료시간은 4자리 숫자로 입력해주세요. (예: 1800)");
        this.value = "";
        this.focus();
      }
    });

    document.getElementById("certName").addEventListener("blur", function () {
      this.value = this.value.replace(/\s+/g, "");
    });

    document
      .getElementById("bankAccount")
      .addEventListener("blur", function () {
        this.value = this.value.replace(/-/g, "");
      });

    let currentYesCallback = null;
    let currentNoCallback = null;

    document
      .getElementById("confirmYesBtn")
      .addEventListener("click", function () {
        if (currentYesCallback) currentYesCallback();
        closeModal("confirmModal");
      });

    document
      .getElementById("confirmNoBtn")
      .addEventListener("click", function () {
        if (currentNoCallback) currentNoCallback();
        closeModal("confirmModal");
      });

    window.showConfirm = function (message, yesCallback, noCallback) {
      currentYesCallback = yesCallback;
      currentNoCallback = noCallback;

      document.getElementById("confirmModalMessage").textContent = message;
      document.getElementById("confirmModal").style.display = "flex";
    };

    document
      .getElementById("saveQualificationBtn")
      .addEventListener("click", async function () {
        try {
          const certName = document.getElementById("certName").value.trim();
          const certNumber = document
            .getElementById("certNumber")
            .value.trim();
          const certDate = document.getElementById("certDate").value.trim();
          const certExpiryDate = document
            .getElementById("certExpiryDate")
            .value.trim();
          const certIssuer = document
            .getElementById("certIssuer")
            .value.trim();

          const employeeId = document
            .getElementById("employeeId")
            .value.trim();
          const employeeName = document.getElementById("name").value.trim();

          if (!certName) {
            showAlert("자격증명을 입력해주세요.");
            return;
          }

          if (!employeeId) {
            showAlert("직원을 먼저 선택해주세요.");
            return;
          }

          if (employeeId === "신규직원등록중") {
            showAlert("직원을 먼저 등록 후 자격사항을 추가해주세요.");
            return;
          }

          showLoading();

          const formData = {
            employeeId: employeeId,
            employeeName: employeeName,
            certName: certName,
            certNumber: certNumber,
            certDate: certDate,
            certExpiryDate: certExpiryDate,
            certIssuer: certIssuer,
          };

          await append_CertLineData(formData);

          document.getElementById("certName").value = "";
          document.getElementById("certNumber").value = "";
          document.getElementById("certDate").value = "";
          document.getElementById("certExpiryDate").value = "";
          document.getElementById("certIssuer").value = "";

          await loadCertData();

          table_selectedEmployeeCert(employeeId);

          hideLoading();

          showAlert("자격증 정보가 저장되었습니다.");
        } catch (error) {
          hideLoading();
          showAlert("자격증 저장 중 오류가 발생했습니다: " + error);
        }
      });
  });

  document.addEventListener("DOMContentLoaded", function () {
    window.currentYesCallback = null;
    window.currentNoCallback = null;

    document.querySelectorAll(".modal-close").forEach(function (closeBtn) {
      closeBtn.addEventListener("click", function () {
        const modal = this.closest(".modal-overlay");
        if (modal) {
          closeModal(modal.id);
        }
      });
    });

    document
      .getElementById("modalConfirmBtn")
      .addEventListener("click", function () {
        closeModal("customModal");
      });

    document
      .getElementById("confirmYesBtn")
      .addEventListener("click", function () {
        if (currentYesCallback) currentYesCallback();
        closeModal("confirmModal");
      });

    document
      .getElementById("confirmNoBtn")
      .addEventListener("click", function () {
        if (currentNoCallback) currentNoCallback();
        closeModal("confirmModal");
      });
  });
</script>

</html>